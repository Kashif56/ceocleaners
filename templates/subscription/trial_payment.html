{% extends 'base.html' %}

{% block title %}Start Your 30-Day Trial{% endblock %}

{% block extra_css %}
<style>
    .trial-features {
        margin-bottom: 1.5rem;
    }
    .trial-features li {
        margin-bottom: 0.75rem;
    }
    .trial-card {
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .trial-price {
        font-size: 2.5rem;
        font-weight: bold;
        color: #4a6cf7;
    }
    .trial-period {
        font-size: 1.1rem;
        color: #6c757d;
    }
    .payment-form {
        max-width: 500px;
        margin: 0 auto;
    }
    #card-container {
        min-height: 90px;
        margin-bottom: 20px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        padding: 12px;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    #card-container.focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    .payment-button {
        width: 100%;
        padding: 12px;
        font-size: 1.1rem;
    }
    .payment-errors {
        color: #dc3545;
        margin-top: 10px;
    }
    .payment-success {
        color: #28a745;
        margin-top: 10px;
    }
    .payment-processing {
        display: none;
        text-align: center;
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'subscription:subscription_management' %}">Subscription</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Start Trial</li>
                </ol>
            </nav>

            <!-- Header Section -->
            <div class="text-center mb-5">
                <h1 class="h2 mb-3">Start Your 30-Day Trial</h1>
                <p class="text-muted">Try our full service for just $30 for 30 days</p>
            </div>

            <div class="row">
                <!-- Trial Plan Details -->
                <div class="col-md-5 mb-4 mb-md-0">
                    <div class="card trial-card h-100">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">{{ trial_plan.name }}</h5>
                        </div>
                        <div class="card-body">
                            <div class="text-center mb-4">
                                <span class="trial-price">${{ trial_plan.price }}</span>
                                <span class="trial-period d-block">for {{ trial_plan.duration_days }} days</span>
                            </div>
                            
                            <div class="trial-features">
                                <h6 class="fw-bold mb-3">What's Included:</h6>
                                <ul class="list-unstyled">
                                    <li>
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        <span>{{ trial_plan.voice_minutes }} Voice Minutes</span>
                                    </li>
                                    <li>
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        <span>{{ trial_plan.sms_messages }} SMS Messages</span>
                                    </li>
                                    <li>
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        <span>{{ trial_plan.agents }} AI Agent</span>
                                    </li>
                                    <li>
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        <span>{{ trial_plan.leads }} Leads</span>
                                    </li>
                                    {% if trial_plan.features.analytics %}
                                    <li>
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        <span>Analytics Dashboard</span>
                                    </li>
                                    {% endif %}
                                    {% if trial_plan.features.custom_voice %}
                                    <li>
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        <span>Custom Voice Settings</span>
                                    </li>
                                    {% endif %}
                                </ul>
                            </div>
                            
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                After your trial ends, you can choose to subscribe to any of our regular plans or cancel.
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Form -->
                <div class="col-md-7">
                    <div class="card trial-card">
                        <div class="card-header">
                            <h5 class="mb-0">Payment Information</h5>
                        </div>
                        <div class="card-body">
                            <form id="payment-form" method="post" class="payment-form">
                                {% csrf_token %}
                                
                                <div class="mb-4">
                                    <label for="card-container" class="form-label">Card Details</label>
                                    <div id="card-container"></div>
                                    <div id="payment-status-container"></div>
                                </div>
                                
                                <div class="mb-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="terms-checkbox" required>
                                        <label class="form-check-label" for="terms-checkbox">
                                            I agree to the <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">Terms and Conditions</a>
                                        </label>
                                    </div>
                                </div>
                                
                                <button id="card-button" type="submit" class="btn btn-primary payment-button">
                                    Pay ${{ trial_plan.price }} and Start Trial
                                </button>
                                
                                <div id="payment-errors" class="payment-errors"></div>
                                <div id="payment-success" class="payment-success"></div>
                                
                                <div id="payment-processing" class="payment-processing">
                                    <div class="spinner-border text-primary mb-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p>Processing your payment...</p>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Terms and Conditions Modal -->
<div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="termsModalLabel">Trial Terms and Conditions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6>30-Day Trial Terms</h6>
                <p>By starting this trial, you agree to the following terms:</p>
                <ul>
                    <li>The trial period lasts for 30 days from the date of purchase.</li>
                    <li>You will be charged a one-time fee of $30 for the trial period.</li>
                    <li>The trial includes limited usage as specified in the trial plan details.</li>
                    <li>After the trial period ends, your subscription will not automatically renew.</li>
                    <li>You can choose to subscribe to any of our regular plans at any time during or after the trial.</li>
                    <li>No refunds will be provided for the trial fee once the trial has started.</li>
                    <li>You can cancel your trial at any time, but the trial fee is non-refundable.</li>
                    <li>All other terms of service for our platform apply during the trial period.</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script type="text/javascript" src="https://sandbox.web.squarecdn.com/v1/square.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', async function() {
        const appId = '{{ square_app_id }}';
        const locationId = '{{ location_id }}';
        
        // Initialize Square
        const payments = Square.payments(appId, locationId);
        
        // Initialize Card
        const card = await payments.card();
        await card.attach('#card-container');
        
        // Handle form submission
        const form = document.getElementById('payment-form');
        const cardButton = document.getElementById('card-button');
        const paymentErrors = document.getElementById('payment-errors');
        const paymentSuccess = document.getElementById('payment-success');
        const paymentProcessing = document.getElementById('payment-processing');
        
        form.addEventListener('submit', async function(event) {
            event.preventDefault();
            
            // Check terms checkbox
            const termsCheckbox = document.getElementById('terms-checkbox');
            if (!termsCheckbox.checked) {
                paymentErrors.textContent = 'You must agree to the terms and conditions.';
                return;
            }
            
            // Disable the submit button
            cardButton.disabled = true;
            paymentErrors.textContent = '';
            paymentProcessing.style.display = 'block';
            
            try {
                const result = await card.tokenize();
                if (result.status === 'OK') {
                    // Create a hidden input with the token
                    const hiddenInput = document.createElement('input');
                    hiddenInput.setAttribute('type', 'hidden');
                    hiddenInput.setAttribute('name', 'card-nonce');
                    hiddenInput.setAttribute('value', result.token);
                    form.appendChild(hiddenInput);
                    
                    // Submit the form
                    form.submit();
                } else {
                    paymentErrors.textContent = 'Card tokenization failed.';
                    cardButton.disabled = false;
                    paymentProcessing.style.display = 'none';
                }
            } catch (e) {
                paymentErrors.textContent = e.message;
                cardButton.disabled = false;
                paymentProcessing.style.display = 'none';
            }
        });
        
        // Add focus styling to card container
        const cardContainer = document.getElementById('card-container');
        cardContainer.addEventListener('focus', function() {
            cardContainer.classList.add('focus');
        }, true);
        
        cardContainer.addEventListener('blur', function() {
            cardContainer.classList.remove('focus');
        }, true);
    });
</script>
{% endblock %}
